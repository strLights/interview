# 什么是XSS

XSS，是跨站脚本(Cross-site scripting)的简称



XSS攻击可以分为两类：反射型和存储型，两类的划分依据是“数据存储在服务器与否”

# 反射型XSS（非持久型XSS）
又称非持久型XSS。之所以称为反射型XSS，是因为这种攻击方式的注入代码是从目标服务器通过错误信息、搜索结果等等方式“反射”回来的：发出请求时，XSS代码出现在URL中，作为输入提交到服务器端，服务器端解析后响应，XSS代码随响应内容一起传回给浏览器，最后浏览器解析执行XSS代码。这个过程像一次反射，故叫反射型XSS。 而称为非持久型XSS，则是因为这种攻击方式具有一次性，由于代码注入的是一个动态产生的页面而不是永久的页面，因此这种攻击方式只在点击链接的时候才产生作用。

攻击者通过电子邮件等方式给别人发送带有恶意脚本代码参数的 URL，当 URL 地址被打开时，注入脚本被传输到目标服务器上，然后服务器将注入脚本“反射”到受害者的浏览器上，特有的恶意代码参数被 HTML 解析、执行。

例如，将正常的网页url：

http://www.dvwa.com/vulnerabilities/xss_r/?name=index
改成下面这般便，可以实现恶意弹窗了：

http://www.dvwa.com/vulnerabilities/xss_r/?name=<script>alert(Serendipity)</script>
如果payloda改成下面这个：

http://www.dvwa.com/vulnerabilities/xss_r/?name=<script>alert(document.cookie)</script>
便能实现获取当前用户的cookie，这种攻击结合csrf(跨站请求伪造)，例如通过 XMLHttpRequest与CORS功能将数据发送给攻击方服务器，之后便可以在千里之外模拟用户登录，进而进行恶意操作。

这类攻击也有很多防御手段，其中一种便是利用str_replace将<script>删除，但上有政策下有对策，这类方法可以使用使用双写绕过：

http://www.dvwa.com/vulnerabilities/xss_r/?name=<scr<script>ipt>alert(document.cookie)</script>

更高级别的代码可能会使用preg_replace函数来过滤删除所有关于<script>标签，但使用<IMG src=1 onerror=alert(document.cookie)>也可以得到同样的结果。



## 非持久型 XSS 漏洞攻击的四大特点：
    ① 即时性。不经过服务器存储，直接通过 HTTP 的 GET 和 POST 请求就能完成一次攻击，拿到用户隐私数据；
    ②攻击者需要诱骗点击；
    ③反馈率低，所以较难发现和响应修复；
    ④盗取用户敏感保密信息。

## 防止出现非持久型 XSS 漏洞的五大措施：
    ① Web 页面渲染的所有内容或者渲染的数据都必须来自于服务端；
    ②尽量不要从 URL，document.referrer，document.forms 等这种 DOM API 中获取数据直接渲染；
    ③尽量不要使用 eval, new Function()，document.write()，document.writeln()，window.setInterval()，window.setTimeout()，innerHTML，document.creteElement() 等可执行字符串的方法；
    ④如果做不到以上几点，也必须对涉及 DOM 渲染的方法传入的字符串参数做 escape 转义；
    ⑤ 前端渲染的时候对任何的字段都需要做 escape 转义编码。

# 存储型XSS（持久型XSS）
存储型XSS，又称持久型XSS，他和反射型XSS最大的不同就是，攻击脚本将被永久地存放在目标服务器端（数据库，内存，文件系统等），下次请求目标页面时不用再提交XSS代码。

一般存在于 Form 表单提交等交互功能，如发帖留言，提交文本信息等，黑客利用的 XSS 漏洞，将内容经正常功能提交进入数据库持久保存，当前端页面获得后端从数据库中读出的注入代码时，恰好将其渲染执行。

这种攻击多见于论坛，攻击者在发帖的过程中，将恶意脚本连同正常信息一起注入到帖子的内容之中。随着帖子被论坛服务器存储下来，恶意脚本也永久地被存放在论坛服务器的后端存储器中。当其它用户浏览这个被注入了恶意脚本的帖子的时候，恶意脚本则会在他们的浏览器中得到执行，从而受到了攻击。

可以看到，存储型XSS的攻击方式能够将恶意代码永久地嵌入一个页面当中，所有访问这个页面的用户都将成为受害者。如果我们能够谨慎对待不明链接，那么反射型的XSS攻击将没有多大作为，而存储型XSS则不同，由于它注入的往往是一些我们所信任的页面，因此无论我们多么小心，都难免会受到攻击。可以说，存储型XSS更具有隐蔽性，带来的危害也更大，除非服务器能完全阻止注入，否则任何人都很有可能受到攻击。

存储型XSS攻击，是指将恶意代码被当做正常数据插入到服务器上的数据库中，当用户正常访问页面的时候，恶意代码从数据库中提取出来并被触发。

这类方法和反射型最大的区别在于其攻击载荷的存储位置不同，反射型XSS的攻击载荷并不存储在服务器上，攻击时需要将链接发送给特定用户，存储型XSS的攻击载荷直接保存在了服务器上，因此很多时候是无差别攻击。

例如一个留言板被黑客利用进行XSS攻击，提交了形如<script>alert(“please follow serendipity！”)</script>的代码，那么所有访问这个留言板的用户都将可能执行这段恶意脚本。

利用存储型XSS可实现劫持访问，盗取访问者cookie或者配合csrf攻击完成恶意请求等攻击。


## 持久型 XSS 的三大特点：
    ①持久性，植入在数据库中；
    ②危害面广，甚至可以让用户机器变成 DDoS 攻击的肉鸡；
    ③ 盗取用户敏感私密信息。

## 防止持久型 XSS 漏洞的三大措施： 
    ①后端在入库前应该选择不相信任何前端数据，将所有的字段统一进行转义处理；
    ②后端在输出给前端数据统一进行转义处理；③前端在渲染页面 DOM 的时候应该选择不相信任何后端数据，任何字段都需要做转义处理。